<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>â˜…ë¬´ì¸ í¸ì˜ì â˜† Drivethru</title>
  <style>
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: sans-serif;
      background-color: #f0f0f0;
      padding: 16px;
    }
    .header-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }
    .welcome-text {
      font-size: 20px;
      font-weight: bold;
      max-width: 70%;
    }
    .cart-top-button {
      background-image: linear-gradient(
        90deg,
        rgb(86, 178, 106), rgb(212, 50, 50), yellow, rgb(230, 15, 180), blue, indigo, rgb(245, 246, 245)
      );
      background-size: 300%;
      animation: rainbowBG 10s linear infinite !important;

      color: white;
      border: none;
      border-radius: 8px;
      padding: 6px 12px;
      font-size: 24px;
      cursor: pointer;
    }

@keyframes rainbowBG {
  0% { background-position: 0%; }
  100% { background-position: 100%; }
}
    .terminal {
      background-color: #111;
      color: #0f0;
      padding: 15px;
      border-radius: 10px;
      font-family: 'Courier New', monospace;
      font-size: 13px;
      white-space: pre-wrap;
      margin-bottom: 20px;
      line-height: 1;
      max-height: calc(1.4em * 6 + 30px);
      overflow-y: auto;
    }
    .terminal::before {
      content: "ìƒí’ˆ ì„ íƒ";
      color: #0ff;
      display: block;
      margin-bottom: 10px;
    }
    .icon-grid {
      display: grid;
      grid-template-columns: 1fr !important;
      gap: 12px;
    }
    .icon-button {
      width: 80% !important;
      height: 60px !important;
      margin: 15px auto !important;
      background-color: transparent !important; /* ë°°ê²½ ì œê±° */
      color: transparent !important; /* ë¬´ì§€ê°œ íš¨ê³¼ ìœ„í•´ ê¸°ë³¸ìƒ‰ íˆ¬ëª… ì²˜ë¦¬ */
      border: 2px solid black !important; /* ê²€ì€ìƒ‰ í…Œë‘ë¦¬ */
      border-radius: 10px !important;
      font-size: 56px !important;
      display: flex;
      align-items: center;
      justify-content: center;
      text-align: center;
      box-shadow: none !important; /* ê·¸ë¦¼ì ì œê±° */
      cursor: pointer;
      position: relative;
      transition: background 0.2s;
  
      /* ë¬´ì§€ê°œ í…ìŠ¤íŠ¸ */
      background-image: linear-gradient(
        90deg,
        red, orange, yellow, green, blue, indigo, violet
      );
      background-size: 300%;
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      animation: rainbowText 20s linear infinite !important;
    }

@keyframes rainbowText {
  0% { background-position: 0%; }
  100% { background-position: 100%; }
}
    .icon-button:active {
      background-color: #0056b3 !important;
    }
    .cart-icon {
      position: absolute;
      top: 8px;
      right: 18px;
      font-size: 16px;
      color: #fff;
    }
    @media (max-width: 600px) {
      .icon-button {
        width: 90% !important;
        font-size: 1.25em !important;
        height: 54px !important;
        margin: 11px auto !important;
      }
    }

    .fade-in {
      animation: fadeIn 1s forwards;
    }
    .fade-out {
      animation: fadeOut 1s forwards;
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    @keyframes fadeOut {
      from { opacity: 1; }
      to { opacity: 0; }
    }  

    .cart-modal {
      position: fixed;
      top: 30%;
      left: 5%;
      width: 90vw;
      background: #fff;
      border: 2.5px solid #1976d2;
      border-radius: 18px;
      padding: 42px 18px 36px 18px;
      z-index: 1000;
      box-shadow: 0 10px 28px rgba(0,0,0,0.23);
      max-height: 62vh;
      overflow-y: auto;
      font-size: 24px;
    }
    .cart-item {
      font-size: 26px;
      margin-bottom: 20px;
    }

    .check-icon {
      width: 24px;
      height: 24px;
      margin-left: 8px;
      vertical-align: middle;
    }


    .cart-item-controls {
      display: flex;
      align-items: center;
      gap: 6px;
      margin-top: 6px;
    }
    .cart-item-controls button {
      padding: 9px 22px;
      font-size: 26px;
      cursor: pointer;
      border-radius: 10px;
      border: 1px solid #ccc;
      background: #eee;
      transition: background 0.2s;
    }
    .cart-item-controls button:hover {
      background: #ddd;
    }
    .cart-total {
      margin-top: 30px;
      font-weight: bold;
      font-size: 24px;
      text-align: right;
    }
    .cart-actions {
      text-align: right;
      margin-top: 12px;
    }
    .cart-actions button {
      padding: 14px 36px;
      margin-left: 8px;
      border: none;
      border-radius: 11px;
      cursor: pointer;
      font-weight: bold;
      font-size: 26px;
    }
    .confirm-btn {
      background-color: #4caf50;
      color: white;
    }
    .close-btn {
      background-color: #aaa;
      color: white;
    }
    .payment-select button {
      margin: 6px 8px 0 0;
    }
    .debug-btn {
      margin-left: 14px;
      font-size: 16px;
      border: 1px solid #1976d2;
      background: #fff;
      color: #1976d2;
      border-radius: 7px;
      padding: 5px 15px;
      cursor: pointer;
      transition: background 0.2s;
    }
    .debug-btn:hover {
      background: #1976d2;
      color: #fff;
    }
  </style>
</head>
<body>
  <div id="loadScreen" style="
  position: fixed; top:0; left:0; width:100vw; height:100vh; background:#fff; display:flex; justify-content:center; align-items:center; z-index:2000;">
  <img src="{{ url_for('static', filename='gif/Load.gif') }}" alt="Loading..." style="max-width: 200vw; max-height: 50vh;" />
</div>

<!-- 2) good.gif + ì–´ì„œì˜¤ì„¸ìš” í…ìŠ¤íŠ¸ í™”ë©´ -->
<div id="welcomeScreen" style="
  position: fixed; top:0; left:0; width:100vw; height:100vh; background:#fff; display:none; flex-direction: column; justify-content:center; align-items:center; z-index:2000;">
  <img src="{{ url_for('static', filename='gif/good.gif') }}" alt="Welcome" style="max-width: 50vw; max-height: 50vh;" />
  <div style="font-size: 2rem; margin-top: 16px; color: #333; font-weight: bold;">ì–´ì„œì˜¤ì„¸ìš”</div>
</div>

<!-- ê¸°ì¡´ Drivethru ë³¸ë¬¸ì€ ì—¬ê¸°ë¶€í„° ì‹œì‘ -->
<div id="mainContent" style="display:none;">

<div class="header-row">
  <div class="welcome-text">
    ë¬´ì¸ í¸ì˜ì  Drivethru
    
  </div>
  <button class="cart-top-button" onclick="showCart()">ğŸ›’</button>
  <button class="debug-btn" onclick="showBotGifAndClose()">ë‚˜ê°€ê¸°</button>
</div>

<div class="terminal" id="terminal-log">í™˜ì˜í•©ë‹ˆë‹¤</div>

<div class="icon-grid">
  <!-- ìƒí’ˆ ë²„íŠ¼ ìœ ì§€ -->
    <button class="icon-button" onclick="addToCart('ë¨¹íƒœê¹¡', 1200)">ë¨¹íƒœê¹¡<span class="cart-icon">ğŸ›’</span></button>
    <button class="icon-button" onclick="addToCart('ABCì¿ í‚¤', 1500)">ABCì¿ í‚¤<span class="cart-icon">ğŸ›’</span></button>
    <button class="icon-button" onclick="addToCart('ì˜¤ë ˆì˜¤', 800)">ì˜¤ë ˆì˜¤<span class="cart-icon">ğŸ›’</span></button>
    <button class="icon-button" onclick="addToCart('ì¹¸ìµ¸', 1000)">ì¹¸ìµ¸<span class="cart-icon">ğŸ›’</span></button>
    <button class="icon-button" onclick="addToCart('ê¼¬ë¶ì¹©', 1100)">ê¼¬ë¶ì¹©<span class="cart-icon">ğŸ›’</span></button>
    <button class="icon-button" onclick="addToCart('ì˜¤ê°ì', 1300)">ì˜¤ê°ì<span class="cart-icon">ğŸ›’</span></button>
    <button class="icon-button" onclick="addToCart('ì´ˆì½”ì†¡ì´', 2500)">ì´ˆì½”ì†¡ì´<span class="cart-icon">ğŸ›’</span></button>
    <button class="icon-button" onclick="addToCart('ì¬ì¹©', 1400)">ì¬ì¹©<span class="cart-icon">ğŸ›’</span></button>
</div>

<div id="debug-log" 
     style="
       margin-top: 10px;
       padding: 10px;
       border: 1px solid #1976d2;
       background-color: #e8f0fe;
       height: 120px;
       overflow-y: auto;
       font-family: monospace;
       font-size: 12px;
       white-space: pre-wrap;
       border-radius: 8px;
     ">
  <!-- ë””ë²„ê·¸ ë¡œê·¸ê°€ ì—¬ê¸° í‘œì‹œë©ë‹ˆë‹¤ -->
</div>

<div id="cart-modal" class="cart-modal" style="display: none;"></div>

<script>
  const SERVER_BASE_URL = 'http://192.168.3.5:5000';  // Flask ì„œë²„ ì£¼ì†Œ

  const terminal = document.getElementById('terminal-log');
  const cart = [];
  let isPaying = false;
  let clearStopped = false;

  // í´ë§ í•¸ë“¤ ì „ì—­ ë³€ìˆ˜
  let coinpassPollHandle = null;
  let nextallPollHandle = null;
  let clearPollHandle = null;
  let clearPollStarted = false;

  // í´ë§ ê°„ê²©(ms)
  const COINPASS_POLL_MS = 200;
  const NEXTALL_POLL_MS  = 250;
  const PROCESS_POLL_MS  = 700;

  // === UI ë° ìƒíƒœ ê´€ë¦¬ í•¨ìˆ˜ ===
  function appendTerminal(text) {
    const time = new Date().toLocaleTimeString();
    terminal.textContent += `\n[${time}] ${text}`;
    terminal.scrollTop = terminal.scrollHeight;
  }

  function debugLog(message) {
    const logDiv = document.getElementById('debug-log');
    const time = new Date().toLocaleTimeString();
    logDiv.textContent += `[${time}] ${message}\n`;
    logDiv.scrollTop = logDiv.scrollHeight;
  }

  function addToCart(name, price) {
    if (isPaying) {
      alert("ê²°ì œ ì¤‘ì—ëŠ” ìƒí’ˆì„ ì¶”ê°€í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
      return;
    }
    const item = cart.find(i => i.name === name);
    if (item) {
      item.qty++;
    } else {
      cart.push({ name, qty: 1, price });
    }
    appendTerminal(`ğŸ“¥ ${name} ì¶”ê°€ë¨`);
  }

  function showCart() {
    const modal = document.getElementById('cart-modal');
    if (cart.length === 0) {
      modal.innerHTML =
        `<div style="display:flex;justify-content:space-between;align-items:center;">
          <span style="font-size:1.1em;">ì¥ë°”êµ¬ë‹ˆê°€ ë¹„ì–´ ìˆìŠµë‹ˆë‹¤.</span>
          <button onclick="closeCart()" style="font-size:2em; border:none; background:none; cursor:pointer; margin-left:16px;">âœ–</button>
        </div>`;
    } else if (isPaying) {
      modal.innerHTML = "<p>ê²°ì œì¤‘ì…ë‹ˆë‹¤... ì ì‹œë§Œ ê¸°ë‹¤ë ¤ ì£¼ì„¸ìš”.</p>";
    } else {
      let html = cart.map((item, idx) =>
        `<div class="cart-item">
          <span>${item.name} (${item.price}ì›)</span>
          <div class="cart-item-controls">
            <button onclick="updateQty(${idx}, -1)">â–</button>
            <span>${item.qty}</span>
            <button onclick="updateQty(${idx}, 1)">â•</button>
            <button onclick="removeItem(${idx})">âŒ</button>
          </div>
        </div>`
      ).join("");

      const total = cart.reduce((sum, item) => sum + item.price * item.qty, 0);
      html += `<div class="cart-total">ì´í•©: ${total.toLocaleString()}ì›</div>`;
      html +=
        `<div class="cart-actions">
          <button class="close-btn" onclick="closeCart()">ë‹«ê¸°</button>
          <button class="confirm-btn" onclick="choosePayment()">ê²°ì œí•˜ê¸°</button>
        </div>`;
      modal.innerHTML = html;
    }
    modal.style.display = "block";
  }

  function closeCart() {
    document.getElementById('cart-modal').style.display = "none";
  }

  function closeCartAndReset() {
    closeCart();
    isPaying = false;
    cart.length = 0;
    clearStopped = false;
    appendTerminal('í™˜ì˜í•©ë‹ˆë‹¤.');
  }

  function updateQty(index, change) {
    if (isPaying) return;
    cart[index].qty += change;
    if (cart[index].qty <= 0) cart.splice(index, 1);
    showCart();
  }

  function removeItem(index) {
    if (isPaying) return;
    cart.splice(index, 1);
    showCart();
  }

  function choosePayment() {
    if (cart.length === 0) {
      alert("ì¥ë°”êµ¬ë‹ˆê°€ ë¹„ì–´ ìˆìŠµë‹ˆë‹¤.");
      return;
    }
    const modal = document.getElementById('cart-modal');
    modal.innerHTML =
      `<p>ğŸ’³ ê²°ì œ ìˆ˜ë‹¨ì„ ì„ íƒí•´ì£¼ì„¸ìš”:</p>
      <div class="cart-actions payment-select">
        <button class="confirm-btn" onclick="pay('í˜„ì¥ê²°ì œ')">í˜„ì¥ê²°ì œ</button>
        <button class="confirm-btn" onclick="pay('ì¹´ì¹´ì˜¤í˜ì´')">ì¹´ì¹´ì˜¤í˜ì´</button>
        <button class="close-btn" onclick="closeCart()">ì·¨ì†Œ</button>
      </div>`;
  }

  // === ì•ˆì „í•œ fetch ë˜í¼ ===
  function instantFetch(url, opts = {}) {
    opts.headers = Object.assign({'Content-Type': 'application/json', 'Cache-Control': 'no-cache'}, opts.headers || {});
    if (opts.body && typeof opts.body !== 'string') opts.body = JSON.stringify(opts.body);
    if (url.startsWith('/')) url = SERVER_BASE_URL + url;
    return fetch(url, opts);
  }

  // === ë””ë²„ê·¸: coinpass ê°•ì œ ì „ì†¡ ===
  function sendTestCoinpass() {
    fetch(`${SERVER_BASE_URL}/coinpass`, { method: 'POST', headers: {'Cache-Control': 'no-cache'} })
      .then(res => res.json())
      .then(data => {
        alert('[ë””ë²„ê·¸] coinpass POST ê²°ê³¼: ' + JSON.stringify(data));
        appendTerminal('[ë””ë²„ê·¸] /coinpass POST ì „ì†¡ë¨');
      })
      .catch(e => {
        appendTerminal('[ë””ë²„ê·¸] /coinpass ì „ì†¡ ì‹¤íŒ¨: ' + e);
        console.error(e);
      });
  }

  // === ê²°ì œ í”„ë¡œì„¸ìŠ¤ ì‹œì‘ ===
  async function pay(method) {
    if (isPaying) return;
  isPaying = true;
  clearStopped = false;

  const modal = document.getElementById('cart-modal');
  const total = cart.reduce((sum, item) => sum + item.price * item.qty, 0);
  modal.innerHTML = `<p>${method}ë¡œ ê²°ì œì¤‘ì…ë‹ˆë‹¤... ì‹ í˜¸ ëŒ€ê¸° ì¤‘...</p>`;

  appendTerminal(`ğŸ’³ ${method} ê²°ì œ ìš”ì²­ ì¤‘... ì´ ${total.toLocaleString()}ì›`);

  const cartData = {};
  cart.forEach(item => {
    cartData[item.name] = item.qty;
  });

  // 1) start_payment API í˜¸ì¶œ (ê¸°ì¡´)
  // 1) cash_amount ì „ì†¡ ë° start_payment API í˜¸ì¶œ (ìˆ˜ì •)
  try {
    // ë¨¼ì € ê²°ì œ ê¸ˆì•¡ì„ Rapidì— ì „ì†¡
    const cashRes = await instantFetch('/send_cash_amount', {
      method: 'POST',
      body: { amount: total }
    });
    const cashJson = await cashRes.json();
    if (cashJson.status !== 'cash_sent') {
      appendTerminal('[ì—ëŸ¬] ê²°ì œ ê¸ˆì•¡ ì „ì†¡ ì‹¤íŒ¨: ' + JSON.stringify(cashJson));
      alert("ê²°ì œ ê¸ˆì•¡ ì „ì†¡ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
      isPaying = false;
      closeCart();
      return;
    }
    appendTerminal('âœ… ê²°ì œ ê¸ˆì•¡ ë¡œë´‡ì— ì „ì†¡ ì™„ë£Œ');

    // ê·¸ë¦¬ê³  ê¸°ì¡´ start_payment í˜¸ì¶œ (snack queue ì´ˆê¸°í™” ë° coinpass ëŒ€ê¸°)
    const startRes = await instantFetch('/start_payment', {
      method: 'POST',
      body: { cart: cartData }
    });
    const startJson = await startRes.json();
    if (startJson.status !== 'waiting_for_coinpass') {
      appendTerminal('[ì—ëŸ¬] start_payment ì‘ë‹µ ì´ìƒ: ' + JSON.stringify(startJson));
      alert("ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
      isPaying = false;
      closeCart();
      return;
    }
  } catch (e) {
    appendTerminal('[ì—ëŸ¬] ê²°ì œ ì‹œì‘ ë˜ëŠ” ê¸ˆì•¡ ì „ì†¡ ì‹¤íŒ¨: ' + e);
    alert("ì„œë²„ í†µì‹  ì—ëŸ¬");
    isPaying = false;
    closeCart();
    return;
  }

  appendTerminal(`ğŸ’³ ê²°ì œ ìˆ˜ë‹¨: ${method}`);

  // âœ… 2) í˜„ì¥ê²°ì œë©´ ì´ì•¡ì„ /paypointë¡œ ì „ì†¡
  if (method === 'í˜„ì¥ê²°ì œ') {
    try {
      const payRes = await instantFetch('/paypoint', {
        method: 'POST',
        body: { amount: total }
      });
      const payJson = await payRes.json();
      if (payJson.status === 'sent') {
        appendTerminal(`ğŸ’¸ paypoint ì „ì†¡: ${total.toLocaleString()}ì›`);
        debugLog(`[paypoint] sent: ${JSON.stringify(payJson)}`);
      } else {
        appendTerminal('âš ï¸ paypoint ì „ì†¡ ì‹¤íŒ¨: ' + JSON.stringify(payJson));
      }
    } catch (e) {
      appendTerminal('âš ï¸ paypoint ì „ì†¡ ì—ëŸ¬: ' + e);
    }
  }

  // 3) coinpass í´ë§ ì‹œì‘ (ê¸°ì¡´ ë¡œì§ ê·¸ëŒ€ë¡œ)
  let coinpassReceived = false;
  let coinpassMisses = 0;
  appendTerminal('ğŸ“¡ Coinpass í´ë§ ì‹œì‘');

  coinpassPollHandle = setInterval(async () => {
    try {
      const res = await instantFetch('/check_coinpass');
      const json = await res.json();

      debugLog(`[í´ë§] /check_coinpass ì‘ë‹µ: ${JSON.stringify(json)}`);

      if (json && json.coinpass === true) {
        coinpassReceived = true;
        appendTerminal('ğŸ“¡ Coinpass ì‹ í˜¸ ìˆ˜ì‹ !');

        modal.innerHTML = `<p>ê²°ì œì™„ë£Œ ë¬¼í’ˆì„ í•˜ë‚˜ì”© êº¼ëƒ…ë‹ˆë‹¤.</p>`;

        // clear ì‹ í˜¸ í´ë§ ì‹œì‘
        startClearPoll();

        // coinpass ìƒíƒœ ì¦‰ì‹œ ë¦¬ì…‹
        try {
          await instantFetch('/reset_coinpass', { method: 'POST' });
          appendTerminal('ğŸ” /reset_coinpass í˜¸ì¶œ ì™„ë£Œ');
        } catch (e) {
          appendTerminal('âš ï¸ /reset_coinpass í˜¸ì¶œ ì‹¤íŒ¨: ' + e);
        }

        clearInterval(coinpassPollHandle);
        coinpassPollHandle = null;

        // 4) ë¡œë´‡ ì‘ì—… ì§„í–‰
        proceedRobotWork(modal);

      } else {
        coinpassMisses++;
        if (coinpassMisses % 8 === 0) {
          appendTerminal('Coinpass ì‹ í˜¸ ëŒ€ê¸°ì¤‘...');
        }
      }
    } catch (e) {
      appendTerminal('[ì—ëŸ¬] /check_coinpass í´ë§ ì—ëŸ¬: ' + e);
      console.error(e);
    }
  }, COINPASS_POLL_MS);

  // safety timeout: 2ë¶„ ëŒ€ê¸° í›„ ì‹¤íŒ¨ ì²˜ë¦¬
  setTimeout(() => {
    if (!coinpassReceived) {
      appendTerminal('â³ Coinpass ìµœëŒ€ ëŒ€ê¸° ì‹œê°„ ì´ˆê³¼ â€” ê²°ì œ ì·¨ì†Œ');
      if (coinpassPollHandle) { clearInterval(coinpassPollHandle); coinpassPollHandle = null; }
      isPaying = false;
      modal.innerHTML = `<p>ê²°ì œ ì‹œê°„ì´ ì´ˆê³¼ë˜ì—ˆìŠµë‹ˆë‹¤.</p><button onclick="closeCartAndReset()">ë‹«ê¸°</button>`;
      clearStopped = true;
    }
  }, 120000);
}

  // === coinpass ìˆ˜ì‹  í›„ ë¡œë´‡ ì‘ì—… ì§„í–‰ ===
  async function proceedRobotWork(modal) {
    // ì£¼ë¬¸ ë¬¼í’ˆëª… ë°°ì—´ë¡œ ì •ë¦¬
    const snackOrder = [];
    cart.forEach(item => {
      for (let i = 0; i < item.qty; i++) {
        snackOrder.push(item.name);
      }
    });

    // nextall ì‹ í˜¸ í´ë§ ì‹œì‘ (ë¡œë´‡ ì‘ì—… ì™„ë£Œ ì‹ í˜¸ ê°ì§€)
    nextallPollHandle = setInterval(async () => {
      try {
        const res = await instantFetch('/check_nextall');
        const json = await res.json();

        debugLog(`[í´ë§] /check_nextall ì‘ë‹µ: ${JSON.stringify(json)}`);

        if (json && json.nextall === true) {
          appendTerminal('ğŸ¤– ë¡œë´‡ nextall ì‹ í˜¸ ê°ì§€');

          // ì™„ë£Œ ì¸ë±ìŠ¤ ì¦ê°€ ìš”ì²­ << ì„ë§ˆê°€ ë¬¸ì œì˜€ë‹¤.
          //await instantFetch('/nextall', { method: 'POST' });
          //appendTerminal('ğŸ” /nextall POST ì™„ë£Œ');

          // nextall ì´ë²¤íŠ¸ ë¦¬ì…‹
          //await instantFetch('/reset_nextall', { method: 'POST' });
          //appendTerminal('ğŸ” /reset_nextall POST ì™„ë£Œ');
        }
      } catch (e) {
        appendTerminal('âš ï¸ /check_nextall í´ë§ ì—ëŸ¬: ' + e);
        console.error(e);
      }
    }, NEXTALL_POLL_MS);

    // ì‘ì—… ìˆœì„œëŒ€ë¡œ í•˜ë‚˜ì”© ì™„ë£Œ ì²´í¬
    for (let i = 0; i < snackOrder.length; i++) {
      if (clearStopped) break;
      const snackName = snackOrder[i];
      appendTerminal(`ğŸ¤– [ë¡œë´‡íŒ”] '${snackName}' ì‘ì—… (${i + 1}/${snackOrder.length}) ëŒ€ê¸°ì¤‘`);

      let snackDone = false;
      while (!snackDone) {
        if (clearStopped) break;
        try {
          const res = await instantFetch(`/nextall_done?current=${i}`);
          const json = await res.json();

          debugLog(`[í´ë§] /nextall_done ì‘ë‹µ: ${JSON.stringify(json)}`);

          if (json.done === true) {
            appendTerminal(`âœ… '${snackName}' ì‘ì—… ì™„ë£Œ í™•ì¸`);
            snackDone = true;
            await new Promise(r => setTimeout(r, 1000)); // 1ì´ˆ ëŒ€ê¸° ì¶”ê°€
          } else {
            await new Promise(r => setTimeout(r, PROCESS_POLL_MS));
          }
        } catch (e) {
          appendTerminal('âš ï¸ /nextall_done í™•ì¸ ì˜¤ë¥˜: ' + e);
          await new Promise(r => setTimeout(r, 2000));
        }
      }
    }

    // nextall í´ë§ ì¤‘ì§€
    if (nextallPollHandle) {
      clearInterval(nextallPollHandle);
      nextallPollHandle = null;
    }

    appendTerminal('ğŸ¤– ëª¨ë“  ì‘ì—… ì™„ë£Œ ëŒ€ê¸° ì¤‘...');

    // ì‘ì—… ì™„ë£Œ ì‹ í˜¸ë¡œ stopping ì „ì†¡
    try {
      await instantFetch('/send_stopping', { method: 'POST' });
      appendTerminal('ğŸ”” stopping ì‹ í˜¸ ë¡œë´‡ì— ì „ì†¡ ì™„ë£Œ');
    } catch(e) {
      appendTerminal('âš ï¸ stopping ì‹ í˜¸ ì „ì†¡ ì‹¤íŒ¨: ' + e);
    }
  }
  function addCheckIconToButton(button) {
  // ì´ë¯¸ check ì•„ì´ì½˜ì´ ìˆìœ¼ë©´ ë¦¬í„´
  if (button.querySelector('.check-icon')) return;

  // check.gif ì´ë¯¸ì§€ ì—˜ë¦¬ë¨¼íŠ¸ ìƒì„±
  const checkImg = document.createElement('img');
  checkImg.src = "{{ url_for('static', filename='gif/check.gif') }}";  // check.gif ê²½ë¡œ ë§ì¶°ì„œ ë„£ê¸°
  checkImg.alt = 'Check';
  checkImg.className = 'check-icon';

  // ë²„íŠ¼ ì•ˆì— í…ìŠ¤íŠ¸ ë’¤ìª½ì— ì´ë¯¸ì§€ ì¶”ê°€
  button.appendChild(checkImg);

  // 2ì´ˆ í›„ì— ì´ë¯¸ì§€ ì œê±°
  setTimeout(() => {
    checkImg.remove();
  }, 2000);
}

// ê¸°ì¡´ addToCart í•¨ìˆ˜ ìˆ˜ì • ë¶€ë¶„ (ë§¨ ìœ„ë¶€í„° ì•„ë˜ë¡œ ì½ìœ¼ë©´ ë¨)
function addToCart(name, price) {
  if (isPaying) {
    alert("ê²°ì œ ì¤‘ì—ëŠ” ìƒí’ˆì„ ì¶”ê°€í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
    return;
  }
  const item = cart.find(i => i.name === name);
  if (item) {
    item.qty++;
  } else {
    cart.push({ name, qty: 1, price });
  }
  appendTerminal(`ğŸ“¥ ${name} ì¶”ê°€ë¨`);

  // ëˆŒë¦° ë²„íŠ¼ ì°¾ê¸°
  const buttons = document.querySelectorAll('.icon-button');
  buttons.forEach(button => {
    if (button.textContent.includes(name)) {
      addCheckIconToButton(button);
    }
  });
}
  // === clear ì‹ í˜¸ í´ë§ (ì£¼ë¬¸ ì™„ë£Œ í™•ì¸ìš©) ===
  function startClearPoll() {
    if (clearPollStarted) return;
    clearPollStarted = true;
    appendTerminal('ğŸ“¡ Clear ì‹ í˜¸ í´ë§ ì‹œì‘');

    clearPollHandle = setInterval(async () => {
      if (clearStopped) {
        clearInterval(clearPollHandle);
        clearPollHandle = null;
        clearPollStarted = false;
        return;
      }
      try {
        const res = await instantFetch('/check_clear');
        const json = await res.json();

        debugLog(`[í´ë§] /check_clear ì‘ë‹µ: ${JSON.stringify(json)}`);

        if (json.clear === true) {
          appendTerminal('âœ… ìƒí’ˆ ì£¼ë¬¸ ì™„ë£Œ í™•ì¸');

          // clear ìƒíƒœ ë¦¬ì…‹ ìš”ì²­
          try {
            await instantFetch('/reset_clear', { method: 'POST' });
            appendTerminal('ğŸ” /reset_clear POST ì™„ë£Œ');
          } catch (e) {
            appendTerminal('âš ï¸ /reset_clear í˜¸ì¶œ ì‹¤íŒ¨: ' + e);
          }

          // ì™„ë£Œ ëª¨ë‹¬ í‘œì‹œ
          const modal = document.getElementById('cart-modal');
          modal.innerHTML = `
            <div style="text-align:center;">
              <p>â˜… ìƒí’ˆ ì£¼ë¬¸ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ì´ìš©í•´ì£¼ì…”ì„œ ê°ì‚¬í•©ë‹ˆë‹¤.</p>
              <button onclick="closeCartAndReset()" style="font-size:2em; margin-top:18px;">âœ– ë‹«ê¸°</button>
            </div>
          `;
          modal.style.display = "block";

          clearStopped = true;

          clearInterval(clearPollHandle);
          clearPollHandle = null;
          clearPollStarted = false;
        }
      } catch (e) {
        appendTerminal('âš ï¸ clear ì‹ í˜¸ í´ë§ ì˜¤ë¥˜: ' + e);
      }
    }, 1000);
  }

  function showBotGifAndClose() {
  // 1) í™”ë©´ ë®ëŠ” div ìƒì„±
    const overlay = document.createElement('div');
    overlay.id = 'botOverlay';
    overlay.style.position = 'fixed';
    overlay.style.top = '0';
    overlay.style.left = '0';
    overlay.style.width = '100vw';
    overlay.style.height = '100vh';
    overlay.style.backgroundColor = '#fff';
    overlay.style.display = 'flex';
    overlay.style.flexDirection = 'column';
    overlay.style.justifyContent = 'center';
    overlay.style.alignItems = 'center';
    overlay.style.zIndex = '3000';

  // 2) bot.gif ì´ë¯¸ì§€
    const img = document.createElement('img');
    img.src = "{{ url_for('static', filename='gif/bot.gif') }}";  // ê²½ë¡œ ë§ê²Œ ìˆ˜ì •í•˜ì„¸ìš”
    img.style.maxWidth = '50vw';
    img.style.maxHeight = '50vh';
    overlay.appendChild(img);

  // 3) í…ìŠ¤íŠ¸
    const text = document.createElement('div');
    text.textContent = 'ë‹¤ìŒì— ë˜ ì˜¤ì„¸ìš”!';
    text.style.fontSize = '2rem';
    text.style.color = '#333';
    text.style.fontWeight = 'bold';
    text.style.marginTop = '16px';
    overlay.appendChild(text);

    document.body.appendChild(overlay);

  // 4) 5ì´ˆ í›„ ì¢…ë£Œ ì‹œë„
    setTimeout(() => {
      try {
        window.close();
      } catch (e) {
        alert('í˜ì´ì§€ë¥¼ ë‹«ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì°½ì„ ì§ì ‘ ë‹«ì•„ì£¼ì„¸ìš”.');
      }
    }, 5000);
  }


  window.addEventListener('load', () => {
  const loadScreen = document.getElementById('loadScreen');
  const welcomeScreen = document.getElementById('welcomeScreen');
  const mainContent = document.getElementById('mainContent');

  setTimeout(() => {
    loadScreen.classList.add('fade-out');
    loadScreen.addEventListener('animationend', () => {
      loadScreen.style.display = 'none';

      welcomeScreen.style.display = 'flex';
      welcomeScreen.classList.add('fade-in');
    }, { once: true });

    setTimeout(() => {
      welcomeScreen.classList.remove('fade-in');
      welcomeScreen.classList.add('fade-out');
      welcomeScreen.addEventListener('animationend', () => {
        welcomeScreen.style.display = 'none';

        mainContent.style.display = 'block';
        mainContent.classList.add('fade-in');
      }, { once: true });
    }, 2000); //ìŠ¤ë§ˆì¼íƒ€ì„

  }, 2000); //ë¡œë”©íƒ€ì„
});

</script>

</body>
</html>
